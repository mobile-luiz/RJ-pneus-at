<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Lista de PDFs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset b√°sico */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      padding: 40px 20px;
      margin: 0;
      color: #222;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      width: 100%;
      max-width: 720px;
      background: #fff;
      padding: 40px 48px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgb(0 0 0 / 0.1);
      transition: box-shadow 0.3s ease;
    }
    .container:hover {
      box-shadow: 0 30px 50px rgb(0 0 0 / 0.15);
    }

    h1 {
      font-size: 2.25rem;
      font-weight: 700;
      color: #3b82f6; /* Azul moderno */
      margin-bottom: 32px;
      text-align: center;
      letter-spacing: 0.03em;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      margin-bottom: 32px;
    }

    .filter-group {
      flex: 1 1 220px;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 600;
      font-size: 0.95rem;
      color: #555;
      user-select: none;
    }

    .filter-group input {
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #cbd5e1;
      border-radius: 12px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      outline-offset: 2px;
      outline-color: transparent;
      background-color: #f9fafb;
      color: #111827;
    }
    .filter-group input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 6px #3b82f6aa;
      background-color: #fff;
    }

    #download-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-height: 500px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #a5b4fc transparent;
    }
    #download-list::-webkit-scrollbar {
      width: 8px;
    }
    #download-list::-webkit-scrollbar-track {
      background: transparent;
    }
    #download-list::-webkit-scrollbar-thumb {
      background-color: #a5b4fc;
      border-radius: 8px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    .pdf-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #f3f4f6;
      padding: 14px 20px;
      border-radius: 14px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.05);
      transition: background-color 0.2s ease;
    }
    .pdf-item:hover {
      background-color: #e0e7ff;
    }

    .pdf-item a {
      color: #1e293b;
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding-right: 12px;
      user-select: text;
    }
    .pdf-item a:hover {
      text-decoration: underline;
      color: #2563eb;
    }

    .pdf-item button {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      user-select: none;
      flex-shrink: 0;
    }
    .pdf-item button:hover {
      background-color: #b91c1c;
    }

    #download-list p {
      font-style: italic;
      color: #64748b;
      text-align: center;
      font-size: 1.1rem;
      margin-top: 40px;
      user-select: none;
    }

    @media (max-width: 480px) {
      .container {
        padding: 24px 20px;
      }

      .filters {
        flex-direction: column;
      }

      .filter-group {
        min-width: 100%;
      }

      .pdf-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .pdf-item a {
        white-space: normal;
        font-size: 1.1rem;
      }

      .pdf-item button {
        align-self: flex-end;
        width: 100%;
        padding: 10px 0;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Lista de PDFs salvos">
    <h1>PDFs Salvos</h1>

    <div class="filters" role="region" aria-label="Filtros de busca">
      <div class="filter-group">
        <label for="filterDate">Filtrar por data:</label>
        <input type="date" id="filterDate" aria-describedby="filterDateHelp" />
      </div>
      <div class="filter-group">
        <label for="filterOs">Filtrar por n√∫mero da OS:</label>
        <input
          type="text"
          id="filterOs"
          placeholder="Ex: 7147"
          aria-describedby="filterOsHelp"
          inputmode="numeric"
          pattern="[0-9]*"
        />
      </div>
    </div>

    <div id="download-list" aria-live="polite" aria-atomic="true">Carregando PDFs...</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
  <script>
    let dbGlobal;
    let SQL;
    let allPdfs = [];

    async function initDatabase() {
      SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
      });

      const savedDb = localStorage.getItem("myDatabase");
      if (!savedDb) {
        document.getElementById("download-list").innerHTML = "<p>Nenhum PDF salvo.</p>";
        return;
      }

      const binaryString = atob(savedDb);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      dbGlobal = new SQL.Database(bytes);

      // Busca todos os PDFs no banco para filtro client-side
      const res = dbGlobal.exec("SELECT id, nome, data, conteudo FROM pdfs ORDER BY id DESC");
      if (res.length === 0 || res[0].values.length === 0) {
        document.getElementById("download-list").innerHTML = "<p>Nenhum PDF salvo.</p>";
        return;
      }

      allPdfs = res[0].values.map(row => ({
        id: row[0],
        nome: row[1],
        data: row[2],
        conteudo: row[3]
      }));

      renderPDFs();
    }

    function renderPDFs() {
      const downloadList = document.getElementById("download-list");
      const filterDate = document.getElementById("filterDate").value; // formato ISO YYYY-MM-DD
      const filterOs = document.getElementById("filterOs").value.trim().toLowerCase();

      downloadList.innerHTML = "";

      function extractDateFromName(name) {
        const regex = /\d{4}-\d{2}-\d{2}/;
        const match = name.match(regex);
        return match ? match[0] : null;
      }

      const filtered = allPdfs.filter(pdf => {
        if (filterDate) {
          const dateInName = extractDateFromName(pdf.nome);
          if (dateInName !== filterDate) return false;
        }

        if (filterOs && !pdf.nome.toLowerCase().includes(filterOs)) {
          return false;
        }

        return true;
      });

      if (filtered.length === 0) {
        downloadList.innerHTML = "<p>Nenhum PDF encontrado.</p>";
        return;
      }

      filtered.forEach(({ id, nome, data, conteudo }) => {
        const container = document.createElement("div");
        container.className = "pdf-item";

        const link = document.createElement("a");
        link.href = conteudo;
        link.download = nome;
        link.textContent = `#${id} - ${nome} (${data})`;

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è";
        deleteBtn.onclick = () => excluirPDF(id);

        container.appendChild(link);
        container.appendChild(deleteBtn);
        downloadList.appendChild(container);
      });
    }

    function excluirPDF(id) {
      if (!confirm("Tem certeza que deseja excluir este PDF?")) return;

      dbGlobal.run(`DELETE FROM pdfs WHERE id = ?`, [id]);
      const data = dbGlobal.export();
      const base64Data = btoa(String.fromCharCode(...data));
      localStorage.setItem("myDatabase", base64Data);

      allPdfs = allPdfs.filter(pdf => pdf.id !== id);
      renderPDFs();
    }

    document.getElementById("filterDate").addEventListener("change", renderPDFs);
    document.getElementById("filterOs").addEventListener("input", renderPDFs);

    initDatabase();
  </script>
</body>
</html>
