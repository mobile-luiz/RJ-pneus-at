<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Lista de PDFs</title>
   <!-- Link para favicon -->
  <link rel="icon" type="image/png" href="rjlogo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset b√°sico */
    * * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f4f6f8;
  color: #333;
  padding: 20px;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 24px;
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

h1 {
  text-align: center;
  margin-bottom: 24px;
  color: #2c3e50;
}

.filters {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 30px;
}

.filter-group {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 200px;
}

label {
  margin-bottom: 6px;
  font-weight: 600;
  color: #34495e;
}

input[type="date"],
input[type="text"] {
  padding: 10px;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  background-color: #fdfdfd;
  transition: border-color 0.2s;
}

input:focus {
  border-color: #007bff;
  outline: none;
}

#download-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.pdf-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background-color: #ecf0f1;
  border-radius: 10px;
  transition: background-color 0.2s ease;
}

.pdf-item:hover {
  background-color: #dfe6e9;
}

.pdf-item a {
  color: #2d3436;
  text-decoration: none;
  font-weight: 500;
  max-width: 75%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.pdf-item button {
  background-color: #3498db;
  border: none;
  color: #fff;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: background-color 0.3s;
}

.pdf-item button:hover {
  background-color: #2980b9;
}

/* Responsividade para mobile */
@media (max-width: 600px) {
  .filters {
    flex-direction: column;
    gap: 12px;
  }

  .pdf-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .pdf-item a {
    max-width: 100%;
    white-space: normal;
    font-size: 1rem;
  }

  .pdf-item button {
    width: 100%;
    font-size: 1rem;
  }
}

  
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Lista de PDFs salvos">
    <h1>PDFs Salvos</h1>

    <div class="filters" role="region" aria-label="Filtros de busca">
      <div class="filter-group">
        <label for="filterDate">Filtrar por data:</label>
        <input type="date" id="filterDate" aria-describedby="filterDateHelp" />
      </div>
      <div class="filter-group">
        <label for="filterOs">Filtrar por n√∫mero da OS:</label>
        <input
          type="text"
          id="filterOs"
          placeholder="Ex: 7147"
          aria-describedby="filterOsHelp"
          inputmode="numeric"
          pattern="[0-9]*"
        />
      </div>
    </div>

    <div id="download-list" aria-live="polite" aria-atomic="true">Carregando PDFs...</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
  <script>
    let dbGlobal;
    let SQL;
    let allPdfs = [];

    async function initDatabase() {
      SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
      });

      const savedDb = localStorage.getItem("myDatabase");
      if (!savedDb) {
        document.getElementById("download-list").innerHTML = "<p>Nenhum PDF salvo.</p>";
        return;
      }

      const binaryString = atob(savedDb);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      dbGlobal = new SQL.Database(bytes);

      // Busca todos os PDFs no banco para filtro client-side
      const res = dbGlobal.exec("SELECT id, nome, data, conteudo FROM pdfs ORDER BY id DESC");
      if (res.length === 0 || res[0].values.length === 0) {
        document.getElementById("download-list").innerHTML = "<p>Nenhum PDF salvo.</p>";
        return;
      }

      allPdfs = res[0].values.map(row => ({
        id: row[0],
        nome: row[1],
        data: row[2],
        conteudo: row[3]
      }));

      renderPDFs();
    }

    function renderPDFs() {
      const downloadList = document.getElementById("download-list");
      const filterDate = document.getElementById("filterDate").value; // formato ISO YYYY-MM-DD
      const filterOs = document.getElementById("filterOs").value.trim().toLowerCase();

      downloadList.innerHTML = "";

      function extractDateFromName(name) {
        const regex = /\d{4}-\d{2}-\d{2}/;
        const match = name.match(regex);
        return match ? match[0] : null;
      }

      const filtered = allPdfs.filter(pdf => {
        if (filterDate) {
          const dateInName = extractDateFromName(pdf.nome);
          if (dateInName !== filterDate) return false;
        }

        if (filterOs && !pdf.nome.toLowerCase().includes(filterOs)) {
          return false;
        }

        return true;
      });

      if (filtered.length === 0) {
        downloadList.innerHTML = "<p>Nenhum PDF encontrado.</p>";
        return;
      }

      filtered.forEach(({ id, nome, data, conteudo }) => {
        const container = document.createElement("div");
        container.className = "pdf-item";

        const link = document.createElement("a");
        link.href = conteudo;
        link.download = nome;
        link.textContent = `#${id} - ${nome} (${data})`;

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è";
        deleteBtn.onclick = () => excluirPDF(id);

        container.appendChild(link);
        container.appendChild(deleteBtn);
        downloadList.appendChild(container);
      });
    }

    function excluirPDF(id) {
      if (!confirm("Tem certeza que deseja excluir este PDF?")) return;

      dbGlobal.run(`DELETE FROM pdfs WHERE id = ?`, [id]);
      const data = dbGlobal.export();
      const base64Data = btoa(String.fromCharCode(...data));
      localStorage.setItem("myDatabase", base64Data);

      allPdfs = allPdfs.filter(pdf => pdf.id !== id);
      renderPDFs();
    }

    document.getElementById("filterDate").addEventListener("change", renderPDFs);
    document.getElementById("filterOs").addEventListener("input", renderPDFs);

    initDatabase();
  </script>
</body>
</html>
